{"version":3,"file":"build.js","names":["path","require","prompt","fs","async","crypto","Q","_","createHash","recursive","hidefile","chcpContext","module","exports","execute","context","executeDfd","defer","config","prepareConfig","ignore","ignoredFiles","sourceDirectory","err","files","hashQueue","prepareFilesHashQueue","parallelLimit","result","sort","a","b","file","localeCompare","json","JSON","stringify","manifestFile","manifestFilePath","writeFile","console","log","argv","localdev","update","projectsConfigFilePath","release","resolve","promise","queue","i","isHiddenSync","push","hashFile","bind","readFileSync","defaultConfig","parse","process","env","VERSION","calculateTimestamp","e","autogenerated","content_url","filename","callback","hash","stream","createReadStream","on","data","digest","relative","replace","RegExp","currentdate","Date","getFullYear","getMonth","getDate","getHours","getMinutes","getSeconds"],"sources":["../src/build.js"],"sourcesContent":["(function() {\n  var path = require('path'),\n    prompt = require('prompt'),\n    fs = require('fs-extra'),\n    async = require('async'),\n    crypto = require('crypto'),\n    Q = require('q'),\n    _ = require('lodash'),\n    createHash = require('crypto').createHash,\n    recursive = require('recursive-readdir'),\n    hidefile = require('hidefile'),\n    chcpContext;\n\n  module.exports = {\n    execute: execute\n  };\n\n  function execute(context) {\n    chcpContext = context;\n\n    var executeDfd = Q.defer(),\n      config = prepareConfig(context),\n      ignore = context.ignoredFiles;\n\n    recursive(chcpContext.sourceDirectory, ignore, function(err, files) {\n      var hashQueue = prepareFilesHashQueue(files);\n\n      async.parallelLimit(hashQueue, 10, function(err, result) {\n        result.sort((a, b) => {\n          return a.file.localeCompare(b.file)\n        });\n        var json = JSON.stringify(result, null, 2);\n        var manifestFile = chcpContext.manifestFilePath;\n\n        fs.writeFile(manifestFile, json, function(err) {\n          if (err) {\n            return console.log(err);\n          }\n\n          if (context.argv && context.argv.localdev) {\n            config.update = 'now';\n          }\n          var json = JSON.stringify(config, null, 2);\n          fs.writeFile(chcpContext.projectsConfigFilePath, json, function(err) {\n            if (err) {\n              return console.log(err);\n            }\n            console.log('Build ' + config.release + ' created in ' + chcpContext.sourceDirectory);\n            executeDfd.resolve(config);\n          });\n        });\n      });\n    });\n\n    return executeDfd.promise;\n  }\n\n  function prepareFilesHashQueue(files) {\n    var queue = [];\n    for (var i in files) {\n      var file = files[i];\n      if (!hidefile.isHiddenSync(file)) {\n        queue.push(hashFile.bind(null, file));\n      }\n    }\n\n    return queue;\n  }\n\n  function prepareConfig(context) {\n    var config = {};\n\n    try {\n      config = fs.readFileSync(context.defaultConfig, 'utf8');\n      config = JSON.parse(config);\n      config.release = process.env.VERSION || calculateTimestamp();\n    } catch (e) {\n      config = {\n        autogenerated: true,\n        release: calculateTimestamp()\n      };\n    }\n\n    if (context.argv && context.argv.content_url) {\n      config.content_url = context.argv.content_url;\n    }\n\n    console.log('Config', config);\n    return config;\n  }\n\n  function hashFile(filename, callback) {\n    var hash = crypto.createHash('md5'),\n      stream = fs.createReadStream(filename);\n\n    //stream.pipe(writeStream);\n    //console.log('Hashing: ', filename);\n    stream.on('data', function(data) {\n      hash.update(data, 'utf8');\n    });\n\n    stream.on('end', function() {\n      var result = hash.digest('hex'),\n        file = path.relative(chcpContext.sourceDirectory, filename).replace(new RegExp(\"\\\\\\\\\", \"g\"), \"/\");\n\n      callback(null, {\n        file: file,\n        hash: result\n      });\n    });\n  }\n\n  function calculateTimestamp() {\n    var currentdate = new Date();\n    return currentdate.getFullYear() + '.' +\n      (((currentdate.getMonth() + 1) < 10) ? '0' + (currentdate.getMonth() + 1) : (currentdate.getMonth() + 1)) + '.' +\n      ((currentdate.getDate() < 10) ? '0' + currentdate.getDate() : currentdate.getDate()) + '-' +\n      ((currentdate.getHours() < 10) ? '0' + currentdate.getHours() : currentdate.getHours()) + '.' +\n      ((currentdate.getMinutes() < 10) ? '0' + currentdate.getMinutes() : currentdate.getMinutes()) + '.' +\n      ((currentdate.getSeconds() < 10) ? '0' + currentdate.getSeconds() : currentdate.getSeconds());\n  }\n})();\n"],"mappings":"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","ignoreList":[]}