{"version":3,"file":"deploy.js","names":["path","require","prompt","build","execute","fs","Q","_","AWS","readdirp","loginFile","join","process","cwd","module","exports","context","executeDfd","defer","then","deploy","resolve","catch","err","console","error","reject","promise","config","credentials","ignore","ignoredFiles","log","readFileSync","defaultConfig","JSON","parse","e","exit","filter","ignoredFile","match","map","files","sourceDirectory","fileFilter","update","accessKeyId","key","secretAccessKey","secret","region","s3region","s3","S3","uploadPromises","on","entry","fileKey","s3prefix","posix","fileContent","fullPath","uploadParams","Bucket","s3bucket","Key","Body","ACL","CacheControl","Expires","Date","uploadPromise","upload","data","Location","push","Promise","all","stack"],"sources":["../src/deploy.js"],"sourcesContent":["(function(){\n  var path = require('path'),\n      prompt = require('prompt'),\n      build = require('./build.js').execute,\n      fs = require('fs'),\n      Q = require('q'),\n      _ = require('lodash'),\n      AWS = require('aws-sdk'),\n      readdirp = require('readdirp'),\n      loginFile = path.join(process.cwd(), '.chcplogin');\n\n  module.exports = {\n    execute: execute\n  };\n\n  function execute(context) {\n    var executeDfd = Q.defer();\n\n    build(context).then(function(){\n      return deploy(context);\n    }).then(function(){\n      executeDfd.resolve();\n    }).catch(function(err) {\n      console.error('Deploy failed:', err);\n      executeDfd.reject(err);\n    });\n\n    return executeDfd.promise;\n  }\n\n  function deploy(context) {\n    var executeDfd = Q.defer(),\n        config,\n        credentials,\n        ignore = context.ignoredFiles;\n\n    console.log('Starting deploy process...');\n\n    try {\n      config = fs.readFileSync(context.defaultConfig, 'utf8');\n      config = JSON.parse(config);\n      console.log('Config loaded successfully');\n    } catch(e) {\n      console.log('Cannot parse cordova-hcp.json. Did you run cordova-hcp init?');\n      process.exit(0);\n    }\n    if(!config) {\n      console.log('You need to run \"cordova-hcp init\" before you can run \"cordova-hcp login\".');\n      console.log('Both commands needs to be invoked in the root of the project directory.');\n      process.exit(0);\n    }\n    try {\n      credentials = fs.readFileSync(loginFile, 'utf8');\n      credentials = JSON.parse(credentials);\n      console.log('Credentials loaded successfully');\n    } catch(e) {\n      console.log('Cannot parse .chcplogin: ', e);\n    }\n    if(!credentials) {\n      console.log('You need to run \"cordova-hcp login\" before you can run \"cordova-hcp deploy\".');\n      process.exit(0);\n    }\n\n    ignore = ignore.filter( ignoredFile => !ignoredFile.match(/^chcp/) )\n    ignore = ignore.map( ignoredFile => `!${ignoredFile}` )\n\n    // console.log('Credentials: ', credentials);\n    // console.log('Config: ', config);\n    // console.log('Ignore: ', ignore);\n\n    var files = readdirp(context.sourceDirectory, {\n      fileFilter: ignore\n    });\n\n    // Configure AWS\n    AWS.config.update({\n      accessKeyId: credentials.key,\n      secretAccessKey: credentials.secret,\n      region: config.s3region\n    });\n    \n    var s3 = new AWS.S3();\n    var uploadPromises = [];\n\n    files.on('data', function(entry) {\n      var fileKey = config.s3prefix ? path.posix.join(config.s3prefix, entry.path) : entry.path;\n      var fileContent = fs.readFileSync(entry.fullPath);\n      \n      var uploadParams = {\n        Bucket: config.s3bucket,\n        Key: fileKey,\n        Body: fileContent,\n        ACL: 'public-read',\n        CacheControl: 'no-cache, no-store, must-revalidate',\n        Expires: new Date(0)\n      };\n\n      var uploadPromise = s3.upload(uploadParams).promise()\n        .then(function(data) {\n          console.log(\"Updated \" + entry.fullPath + ' -> ' + data.Location);\n        })\n        .catch(function(err) {\n          console.error(\"Failed to upload \" + entry.fullPath + \":\", err);\n          throw err;\n        });\n      \n      uploadPromises.push(uploadPromise);\n    });\n\n    files.on('end', function() {\n      console.log('Deploy started');\n      Promise.all(uploadPromises)\n        .then(function() {\n          console.log(\"Deploy done\");\n          executeDfd.resolve();\n        })\n        .catch(function(err) {\n          console.error(\"unable to sync:\", err);\n          executeDfd.reject();\n        });\n    });\n\n    files.on('error', function(err) {\n      console.error(\"unable to sync:\", err.stack);\n      executeDfd.reject();\n    });\n    return executeDfd.promise;\n  }\n})();\n"],"mappings":"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","ignoreList":[]}